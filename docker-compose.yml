# Docker Compose - Multi-Agent Crypto System
# ==========================================
# 
# Agenti:
#   - data-fetcher: Daemon che scarica Top 100 crypto e aggiorna candele ogni 15 min
#   - frontend: Dashboard Streamlit con grafici e lista Top 100
#
# Uso:
#   docker-compose up -d                          # Avvia tutto in background
#   docker-compose up -d data-fetcher             # Solo data-fetcher daemon
#   docker-compose up -d frontend                 # Solo frontend
#   docker-compose logs -f data-fetcher           # Vedi logs del fetcher
#   docker-compose run data-fetcher --once        # Singolo download (no daemon)
#

services:
  # =========================================
  # DATA FETCHER AGENT (DAEMON)
  # =========================================
  # Scarica Top 100 all'avvio, poi aggiorna candele ogni 15 minuti
  # Per forzare refresh lista: crea file shared/refresh_signal.txt
  data-fetcher:
    build:
      context: ./agents/data-fetcher
      dockerfile: Dockerfile
    container_name: crypto-data-fetcher
    volumes:
      - shared-data:/app/shared
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - SHARED_DATA_PATH=/app/shared
    networks:
      - trading-network
    restart: unless-stopped  # Daemon che gira continuamente
    
  # =========================================
  # HISTORICAL DATA AGENT (ML Data)
  # =========================================
  # Downloads 12+ months of historical data for ML training
  # Runs backfill on startup, then incremental updates every 15 min
  historical-data:
    build:
      context: ./agents/historical-data
      dockerfile: Dockerfile
    container_name: crypto-historical-data
    command: python main.py
    volumes:
      - shared-data:/app/shared
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - SHARED_DATA_PATH=/app/shared
      - LOG_LEVEL=INFO
    networks:
      - trading-network
    restart: unless-stopped
    depends_on:
      - data-fetcher  # Needs top_symbols table from data-fetcher

  # =========================================
  # ML INFERENCE AGENT
  # =========================================
  # Runs XGBoost inference every 5 minutes on all symbols
  # Saves ML scores to database for frontend to display
  ml-inference:
    build:
      context: ./agents/ml-inference
      dockerfile: Dockerfile
    container_name: crypto-ml-inference
    volumes:
      - shared-data:/app/shared
    environment:
      - SHARED_DATA_PATH=/app/shared
      - INFERENCE_INTERVAL=300          # 5 minutes
      - INFERENCE_TIMEFRAME=15m
      - LOG_LEVEL=INFO
    networks:
      - trading-network
    restart: unless-stopped
    depends_on:
      - historical-data  # Needs OHLCV data

  # =========================================
  # FRONTEND AGENT (Streamlit Dashboard)
  # =========================================
  frontend:
    build:
      context: ./agents/frontend
      dockerfile: Dockerfile
    container_name: crypto-frontend
    ports:
      - "8501:8501"
    volumes:
      - shared-data:/app/shared
    # Resource limits to prevent Optuna training from consuming all resources
    deploy:
      resources:
        limits:
          cpus: '4'      # Max 4 CPU cores (enough for Optuna but won't block system)
          memory: 4G     # Max 4GB RAM
        reservations:
          cpus: '0.5'    # Reserve at least 0.5 CPU
          memory: 256M   # Reserve at least 256MB
    environment:
      - SHARED_DATA_PATH=/app/shared
      # Bybit API (for balance, positions, trading)
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      # OpenAI API (for AI analysis)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # CoinMarketCap API (for sentiment)
      - CMC_PRO_API_KEY=${CMC_PRO_API_KEY}
      # Trading defaults
      - DEFAULT_LEVERAGE=${DEFAULT_LEVERAGE:-5}
      - DEFAULT_STOP_LOSS_PCT=${DEFAULT_STOP_LOSS_PCT:-2.0}
      - DEFAULT_TAKE_PROFIT_PCT=${DEFAULT_TAKE_PROFIT_PCT:-4.0}
    networks:
      - trading-network
    restart: unless-stopped
    depends_on:
      - data-fetcher

# =========================================
# NETWORKS
# =========================================
networks:
  trading-network:
    driver: bridge
    name: trading-network

# =========================================
# VOLUMES
# =========================================
volumes:
  shared-data:
    name: crypto-shared-data
    driver: local
